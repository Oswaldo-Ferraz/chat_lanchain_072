name: Complete CI/CD Pipeline
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite executar manualmente

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ğŸ” Validate Docker Compose file
        run: |
          echo "ğŸ” Validando arquivo docker-compose..."
          
          if [ -f "langchain_fastapi.yml" ]; then
            echo "âœ… Arquivo langchain_fastapi.yml encontrado"
            
            # Verificar sintaxe YAML
            python -c "import yaml; yaml.safe_load(open('langchain_fastapi.yml'))"
            echo "âœ… Sintaxe YAML vÃ¡lida"
            
            # Verificar se contÃ©m serviÃ§os necessÃ¡rios
            if grep -q "services:" langchain_fastapi.yml; then
              echo "âœ… SeÃ§Ã£o 'services' encontrada"
            else
              echo "âŒ SeÃ§Ã£o 'services' nÃ£o encontrada"
              exit 1
            fi
            
          else
            echo "âŒ Arquivo langchain_fastapi.yml nÃ£o encontrado"
            exit 1
          fi
      
      - name: ğŸ§ª Test Python syntax
        run: |
          echo "ğŸ§ª Testando sintaxe Python..."
          
          if [ -f "src/langchain_fastapi.py" ]; then
            echo "âœ… Arquivo src/langchain_fastapi.py encontrado"
            python -m py_compile src/langchain_fastapi.py
            echo "âœ… Sintaxe Python vÃ¡lida"
          else
            echo "âŒ Arquivo src/langchain_fastapi.py nÃ£o encontrado"
            exit 1
          fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check Portainer connection
        run: |
          echo "ğŸ” Testando conexÃ£o com Portainer..."
          
          # Verificar se Portainer estÃ¡ acessÃ­vel
          if curl -f -s --max-time 10 "${{ secrets.PORTAINER_URL }}/api/system/version" > /dev/null; then
            echo "âœ… Portainer estÃ¡ acessÃ­vel"
          else
            echo "âŒ Falha na conexÃ£o com Portainer"
            echo "Tentando novamente em 30 segundos..."
            sleep 30
            
            if curl -f -s --max-time 10 "${{ secrets.PORTAINER_URL }}/api/system/version" > /dev/null; then
              echo "âœ… Portainer conectado na segunda tentativa"
            else
              echo "âŒ Portainer inacessÃ­vel apÃ³s duas tentativas"
              exit 1
            fi
          fi
      
      - name: ğŸ” Get current stack info
        id: stack-info
        run: |
          echo "ğŸ” Verificando stacks existentes..."
          
          # Buscar stack existente no Portainer
          STACK_ID=$(curl -s --max-time 30 \
            -H "X-API-Key: ${{ secrets.PORTAINER_TOKEN }}" \
            "${{ secrets.PORTAINER_URL }}/api/stacks" | \
            jq -r '.[] | select(.Name=="langchain-api") | .Id // empty' 2>/dev/null || echo "")
          
          if [ ! -z "$STACK_ID" ]; then
            echo "stack_exists=true" >> $GITHUB_OUTPUT
            echo "stack_id=$STACK_ID" >> $GITHUB_OUTPUT
            echo "âœ… Stack existente encontrada: ID $STACK_ID"
          else
            echo "stack_exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ†• Nenhuma stack encontrada - serÃ¡ criada nova"
          fi
      
      - name: ğŸ”„ Update existing stack
        if: steps.stack-info.outputs.stack_exists == 'true'
        run: |
          echo "ğŸ”„ Atualizando stack existente ID: ${{ steps.stack-info.outputs.stack_id }}"
          
          # Atualizar stack via Git Repository method
          RESPONSE=$(curl -s -w "%{http_code}" --max-time 60 \
            -X PUT \
            -H "X-API-Key: ${{ secrets.PORTAINER_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.PORTAINER_URL }}/api/stacks/${{ steps.stack-info.outputs.stack_id }}/git/redeploy" \
            -d '{
              "env": [
                {
                  "name": "OPENAI_API_KEY",
                  "value": "${{ secrets.OPENAI_API_KEY }}"
                }
              ],
              "prune": true,
              "pullImage": true
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -c 4)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Stack atualizada com sucesso!"
          else
            echo "âŒ Falha na atualizaÃ§Ã£o da stack. HTTP Code: $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi
      
      - name: ğŸ†• Create new stack
        if: steps.stack-info.outputs.stack_exists == 'false'
        run: |
          echo "ğŸ†• Criando nova stack..."
          
          # Criar nova stack via Repository method
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 120 \
            -X POST \
            -H "X-API-Key: ${{ secrets.PORTAINER_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.PORTAINER_URL }}/api/stacks/create/swarm/repository" \
            -d '{
              "name": "langchain-api",
              "swarmID": "1",
              "repositoryURL": "https://github.com/Oswaldo-Ferraz/chat_lanchain_072",
              "repositoryReferenceName": "",
              "composeFile": "langchain_fastapi.yml",
              "env": [
                {
                  "name": "OPENAI_API_KEY",
                  "value": "${{ secrets.OPENAI_API_KEY }}"
                }
              ],
              "repositoryAuthentication": false,
              "autoUpdate": {
                "interval": "5m",
                "webhook": ""
              }
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Nova stack criada com sucesso!"
          else
            echo "âŒ Falha na criaÃ§Ã£o da stack. HTTP Code: $HTTP_CODE"
            exit 1
          fi
      
      - name: â³ Wait for deployment
        run: |
          echo "â³ Aguardando deploy completar..."
          echo "â³ Aguardando containers iniciarem..."
          sleep 45
      
      - name: ğŸ¥ Health check
        run: |
          echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
          
          # Tentar 8 vezes com intervalo de 15s
          for i in {1..8}; do
            echo "ğŸ” Tentativa $i/8..."
            
            if curl -f -s --max-time 10 "http://147.79.83.6:8000/health" | jq -r '.status' 2>/dev/null | grep -q "healthy"; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ saudÃ¡vel!"
              echo "ğŸ¯ Deploy realizado com sucesso!"
              echo ""
              echo "ğŸ“‹ URLs disponÃ­veis:"
              echo "  ğŸ”— API: http://147.79.83.6:8000"
              echo "  ğŸ“š Docs: http://147.79.83.6:8000/docs"
              echo "  ğŸ¥ Health: http://147.79.83.6:8000/health"
              exit 0
            else
              echo "â³ AplicaÃ§Ã£o ainda nÃ£o estÃ¡ pronta... (aguardando 15s)"
              sleep 15
            fi
          done
          
          echo "âŒ Falha no health check apÃ³s 8 tentativas (2 minutos)"
          echo "ğŸ” Tentando diagnÃ³stico..."
          
          # Verificar se o container existe
          curl -s --max-time 10 "http://147.79.83.6:8000" || echo "Sem resposta HTTP"
          
          exit 1
      
      - name: ğŸ“¢ Success notification
        if: success()
        run: |
          echo "ğŸ‰ CI/CD Pipeline executado com sucesso!"
          echo ""
          echo "ğŸ“Š Resumo do deploy:"
          echo "  ğŸ“¦ RepositÃ³rio: ${{ github.repository }}"
          echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "  ğŸ”— Commit: ${{ github.sha }}"
          echo "  ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "  â° Timestamp: $(date)"
          echo ""
          echo "ğŸš€ AplicaÃ§Ã£o disponÃ­vel em:"
          echo "  ğŸŒ http://147.79.83.6:8000"
          echo "  ğŸ“š http://147.79.83.6:8000/docs"